---
title: "Lesotho Climate Dashboard"
author: "Ashna"
date: "2023-10-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(base)
library(readr)
library(tidyr)
library(dplyr)
library(tidyselect)
library(ggplot2)
library(forcats)
library(shiny)
library(leaflet)
library(tidygeocoder)
library(ggmap)
library(mapview)
library(sf)
library(ggmap)
library(geojsonio)
library(htmltools)
library(sp)
library(geojsonsf)
library(leaflet.extras)
library(shinydashboard)

#D. Kahle and H. Wickham. ggmap: Spatial Visualization with ggplot2. The R Journal, 5(1),
#  144-161. URL http://journal.r-project.org/archive/2013-1/kahle-wickham.pdf
```

```{r District Names & Coordinates}
# should probably chnage this to use api?
df_lab <- data.frame(
  Name = c("Quthing", "Mohale's Hoek", "Qacha's Nek", "Mafeteng", "Maseru", "Thaba-Tseka", "Mokhotlong", "Berea", "Leribe", "Butha-Buthe"),
  Lat = c(-30.413616, -30.127431, -29.964429, -29.757574, -29.565642, -29.5333, -29.2885, -29.2069, -29.018983, -28.823041),
  Long = c(27.970415, 27.668363, 28.701420, 27.378837, 27.796710, 28.6, 29.0656, 27.878, 28.283234, 28.611562)
)
# df_lab <- read.csv(textConnection(
# "Name,Lat,Long
# Quthing,-30.4001,27.7002
# Mohale's Hoek,-30.15,27.4667
# Qacha's Nek,-30.1167,28.6833
# Mafeteng,-29.8167,27.25
# Maseru,-29.31,27.48
# Thaba-Tseka,-29.5333,28.6
# Mokhotlong,-29.2885,29.0656
# Berea,29.2069,27.878
# Leribe,	-28.8734,28.0416
# Butha-Buthe, -28.7833, 28.2333"))
```

```{r Load Info}
#Population Info
df_pop <- read.csv("~/Desktop/Columbia/Fall 23/Practicum/lesotho_pop_short1.csv")

#Climate Info
df_ond <- read.csv("~/Desktop/Columbia/Fall 23/Practicum/LesothoONDData.csv")
df_ond <- df_ond %>%
  mutate(triggered = case_when(
    RainFcstV2 >= FrcstThreshold ~ "yes",
    RainFcstV2 < FrcstThreshold ~ "no")) # add column to indicate whether drought was triggered
```

```{r Lesotho Map Setup}
# original shape file with district boundaries
GeoData <- readLines("~/Desktop/Columbia/Fall 23/Practicum/mygeodata/mygeodata_merged.json") %>% 
  paste(collapse = "\n") 

geojson <- geojsonsf::geojson_sf(GeoData) # Parse GeoJSON data

mgeojson <- merge(geojson, df_pop, by.x = "adm1_name", by.y = "adm1_name") # merge data frames by district names

ondgeojson <- merge(mgeojson, df_ond, by.x = "adm1_name", by.y = "adm1_name") # merge data frames by district names
#final datafram contains population info, forecast info, and shape files info
```

```{r Lesotho Map Colors}
# break up population numbers into 5 sections and assign 5 colors
breaks <- quantile(mgeojson$Total, probs = c(0, 0.2, 0.4, 0.6, 0.8, 1))
colors <- c("lightblue", "aquamarine", "cyan", "darkcyan", "darkslategray")
#colors <- c("gold", "orange", "orangered", "red", "darkred")
#colors <- c("darkseagreen1", "palegreen", "seagreen3", "seagreen4", "darkgreen")

# Create a factor with colors based on quantiles (will add new column and assign color)
mgeojson$ColorFactor <- cut(mgeojson$Total, breaks = breaks, labels = colors[1:5], include.lowest = TRUE)

# create a legend and labels 
# Population
legend_colors <- c("lightblue", "aquamarine", "cyan", "darkcyan", "darkslategray")
    legend_labels <- c("Low Population", "MediumLow Population", "Medium Population","MediumHigh Population", "High Population")

#Forecast
```

```{r Lesotho OND Data Colors}
# break up forecast numbers into 5 sections and assign 5 colors
fcst_breaks <- c(40, 45, 50, 55, 60, 65)
fcst_colors <- c("darkred", "red", "orangered", "orange", "gold")

# Create a factor with colors based on divisions (will add new column and assign color)
ondgeojson$ColorFcst <- cut(ondgeojson$RainFcstV2, breaks = fcst_breaks, labels = fcst_colors[1:5], include.lowest = TRUE)

```


```{r Dashboard UI Inputs}
#header <- dashboardHeader()

# add sections to the sidebar
# can change name, icon, and add a label
sidebar <- dashboardSidebar(
    sidebarMenu(
      menuItem("Dashboard", tabName = "dashboard", icon = icon("house")),
      menuItem("Data", icon = icon("th"), tabName = "data", badgeLabel = "label", badgeColor = "teal"),
      menuItem("Guide", icon = icon("list"), tabName = "guide")
    )
  )

# build dashboard body and assign outputs to a section on the sidebar
body <- dashboardBody(
      #tags$style(type = "text/css", "html, body {width:100%; height:100%}"),
  tabItems(
    tabItem(tabName = "dashboard", #assign section
      fluidRow(column(width = 9, #output width
        box(title = "Lesotho Drought Forecast", width = NULL, leafletOutput("lesotho_map", height = 500), # place the map inside the box
            actionButton("reset_map_button", "Reset Map")),
      ),
      column(width = 3,
       box(title = "Map Viewing Options", width = NULL, height = 500,
        uiOutput("lesotho_level"),
        selectInput("Select_Level", # create a dropdown menu for user to select input
              label = "Mode", 
              choices = c("National" = 1,
                          "District" = 2),
              selected = 1 # the default option to "June"
  ),
        uiOutput("lesotho_month"),
        selectInput("Select_Month", # create a dropdown menu for user to select input
              label = "Month", 
              choices = c("June" = 1,
                          "July" = 2, 
                          "August" = 3),
              selected = 1 # set the default option to "June"
  ),
  uiOutput("lesotho_forecast"),
        selectInput("Trigger_Level", # create a dropdown menu for user to select input
              label = "Select Severity", 
              choices = c("Mild" = 1,
                          "Moderate" = 2, 
                          "Severe" = 3),
              selected = 1 # set the default option to "Mild"
)
      )),
      fluidRow(column(width = 12,
        box(title = "Gantt Chart", width = NULL, height = 500)),
        #column(width = 5,
        #box(title = "Graph2", width = NULL, height = 500))
      )
    )),
    tabItem(tabName = "data",
      fluidRow(column(width = 9,
        box(title = "Graph 1", width = NULL, height = 500),
      ))
    ),
    tabItem(tabName = "guide",
      fluidRow(column(width = 10,
        box(title = "Supporting Materials", width = NULL, height = 500),
      fluidRow(column(width = 10,
        box(title = "FAQ", width = NULL, height = 500))
      )
      ))
    )
  )
)
#dashboardPage(header, sidebar, body)
```

```{r Lesotho Map}
#library(geojsonio)

# add header, sidebar, and body inputs to ui
ui <- dashboardPage(
  dashboardHeader(title = "Lesotho Dashboard"),
  sidebar,
  body
)

#build server
server <- function(input, output, session) {

# Build reactive user input for forecast viewing  
 selected_severity <- reactive({
    severity_level <- input$Trigger_Level
    month_select <- input$Select_Month
    if (severity_level == 1) {
      ondgeojson <- ondgeojson[ondgeojson$TriggerLevel == "mild", ]
    } else if (severity_level == 2) {
      ondgeojson <- ondgeojson[ondgeojson$TriggerLevel == "moderate", ]
    } else if (severity_level == 3) {
      ondgeojson <- ondgeojson[ondgeojson$TriggerLevel == "severe", ]
    } else {
      ondgeojson <- ondgeojson
    }
    
     if (month_select == 1) {
      ondgeojson <- ondgeojson[ondgeojson$Month == "June", ]
    } else if (month_select == 2) {
      ondgeojson <- ondgeojson[ondgeojson$Month == "July", ]
    } else if (month_select == 3) {
      ondgeojson <- ondgeojson[ondgeojson$Month == "August", ]
    } else {
      ondgeojson <- ondgeojson
    }
    
    ondgeojson$ColorFcst <- cut(ondgeojson$RainFcstV2, 
                       breaks = c(25, 30, 35, 40, 45, 50, 55, 60, 65, 70), 
                       labels = c("darkred", "firebrick", "red", "orangered", "darkorange", "orange", "gold", "khaki", "cornsilk"),
                       include.lowest = TRUE)

    return(ondgeojson)
  })

 
# Build Lesotho map
  output$lesotho_map <- renderLeaflet({ 
  #filtered_data <- selected_severity()
    leaflet() %>% setView(lng = 28.2336, lat = -29.6091, zoom = 7.5) %>% # set center coordinates and zoom for initial view
      addTiles() %>% # insert shape files to add district boundaries
      addGeoJSON(GeoData, weight = 1, color = "black", fill = FALSE) %>%
      addLabelOnlyMarkers(data = df_lab, ~Long, ~Lat, label = ~Name, # add district labels
      labelOptions = labelOptions(noHide = T, textsize = "9px", direction = "center", style = list(
        "color" = "black", "font-weight" = "bold", "background" = "transparent", "border" = "none", "box-shadow" = "none"))) %>%
      
      # add hover feature --> district boundaries highlighted when cursor hovers
      addPolygons(data = selected_severity(), color = "#444444", weight = 1, smoothFactor = 0.5,
      opacity = 1.0, fillOpacity = 0.77,
      fillColor = ~ColorFcst,
      highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE)) #%>% 
      
      # add legend
      #addLegend(
      #position = "bottomright",  # adjust position
      #colors = legend_colors,
      #labels = legend_labels,
      #title = "Population Legend (Test)"
    #) 
  })
  
  # function to reset map back to original view
  observeEvent(input$reset_map_button, {
    leafletProxy("lesotho_map") %>% setView(lng = 28.2336, lat = -29.6091, zoom = 7.5)
    #updateSelectInput(session, "Trigger_Level", selected = 1)
  })
  
}


shinyApp(ui, server)
#shiny::runApp("~/Desktop/Columbia/Fall 23")
```

```{r Ignore For Now}
    if (severity_level == 1) {
      return(ondgeojson[ondgeojson$Trigger_Level == "mild", ])
    } else if (severity_level == 2) {
      return(ondgeojson[ondgeojson$Trigger_Level == "moderate", ])
    } else if (severity_level == 3) {
      return(ondgeojson[ondgeojson$Trigger_Level == "severe", ])
    } else {
      return(ondgeojson)
    }
```


```{r ONLY MAP UI}
ui <- fillPage(
  tags$style(type = "text/css", "html, body {width:100%; height:100%}"),
  leafletOutput("lesotho_map", width = "100%", height = "100%") %>% # Define a leaflet map output
   dashboardHeader(title = "Lesotho Dashboard"),
   dashboardSidebar(),
   dashboardBody() %>%
  
  dashboardSidebar(
  sidebarMenu(
    menuItem("Dashboard", tabName = "dashboard", icon = icon("dashboard")),
    menuItem("Widgets", icon = icon("th"), tabName = "widgets",
             badgeLabel = "new", badgeColor = "green")
  )
),
    
    mainPanel(
        leafletOutput("lesotho_map"),
        width = 10
    ))
```


```{r ONLY DASHBOARD UI}
ui <- dashboardPage(
  dashboardHeader(title = "Lesotho Dashboard"),
  dashboardSidebar(
    sidebarMenu(
      menuItem("Dashboard", tabName = "dashboard", icon = icon("dashboard")),
      menuItem("Widgets", tabName = "widgets", icon = icon("th"), badgeLabel = "null", badgeColor = "green")
    )
  ),
  dashboardBody(
    tags$style(type = "text/css", "html, body {width:100%; height:100%}"),
    tabItems(
      tabItem(
        tabName = "dashboard",
        leafletOutput("lesotho_map", width = "100%", height = "100%")
      )
    )
  )
)
```

```{r Population Fill}
server <- function(input, output) {
  output$lesotho_map <- renderLeaflet({
    leaflet() %>% setView(lng = 28.2336, lat = -29.6091, zoom = 7) %>%
      addTiles() %>%
      addGeoJSON(GeoData, weight = 1, color = "black", fill = FALSE) %>%
      addLabelOnlyMarkers(data = df_lab, ~Long, ~Lat, label = ~Name,
      labelOptions = labelOptions(noHide = T, textsize = "9px", style = list(
        "color" = "black", "font-style" = "bold"))) %>%
      addPolygons(data = mgeojson, color = "#444444", weight = 1, smoothFactor = 0.5,
      opacity = 1.0, fillOpacity = 0.5,
      fillColor = ~ColorFactor,
      highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE)) %>% 
      addLegend(
      position = "bottomright",  # Adjust position as needed
      colors = legend_colors,
      labels = legend_labels,
      title = "Population Legend (Test)"
    ) 
  })
}
```


```{r Minimal Code for Testing}
#minimal code
library(shiny)
library(shinydashboard)
library(leaflet)

ui <- dashboardPage(
  dashboardHeader(title = "Lesotho Dashboard"),
  dashboardSidebar(
    sidebarMenu(
      menuItem("Dashboard", tabName = "dashboard", icon = icon("dashboard"))
    )
  ),
  dashboardBody(
    tags$style(type = "text/css", "html, body {width:100%; height:100%}"),
    tabItems(
      tabItem(
        tabName = "dashboard",
        leafletOutput("lesotho_map", width = "100%", height = "100%")
      )
    )
  )
)

server <- function(input, output) {
  output$lesotho_map <- renderLeaflet({
    leaflet() %>%
      setView(lng = 28.2336, lat = -29.6091, zoom = 7) %>%
      addTiles()
  })
}

shinyApp(ui, server)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

