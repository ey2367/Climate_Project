---
title: "Lesotho Climate Dashboard"
author: "Ashna"
date: "2023-10-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(base)
library(readr)
library(tidyr)
library(dplyr)
library(tidyselect)
library(ggplot2)
library(forcats)
library(shiny)
library(leaflet)
library(tidygeocoder)
library(ggmap)
library(mapview)
library(sf)
library(ggmap)
library(geojsonio)
library(htmltools)
library(sp)
library(geojsonsf)
library(leaflet.extras)
library(shinydashboard)
library(rsconnect)
library(here)
library(plotly)
library(readr)
library(viridis)


#D. Kahle and H. Wickham. ggmap: Spatial Visualization with ggplot2. The R Journal, 5(1),
#  144-161. URL http://journal.r-project.org/archive/2013-1/kahle-wickham.pdf
```

```{r District Names & Coordinates}
# should probably chnage this to use api?
df_lab <- data.frame(
  Name = c("Quthing", "Mohale's Hoek", "Qacha's Nek", "Mafeteng", "Maseru", "Thaba-Tseka", "Mokhotlong", "Berea", "Leribe", "Butha-Buthe"),
  Lat = c(-30.413616, -30.127431, -29.964429, -29.757574, -29.565642, -29.5333, -29.2885, -29.2069, -29.018983, -28.823041),
  Long = c(27.970415, 27.668363, 28.701420, 27.378837, 27.796710, 28.6, 29.0656, 27.878, 28.283234, 28.611562)
)
```

```{r Load Info}
#Population Info
#print("here .. loading data ... ")
df_pop <- read.csv(here("lesotho_pop_short1.csv"))

#Climate Info
df_ond <- read.csv(here("LesothoONDData.csv"))
df_ond <- df_ond %>%
  mutate(triggered = case_when(
    RainFcstV2 >= FrcstThreshold ~ "yes",
    RainFcstV2 < FrcstThreshold ~ "no")) # add column to indicate whether drought was triggered

# District Chart Information
df_target_areas <- read.csv('target_areas.csv')

```

```{r Lesotho Map Setup}
# original shape file with district boundaries
#library(here)
GeoData <- readLines(here("mygeodata_merged.json")) %>% 
  paste(collapse = "\n") 

geojson <- geojsonsf::geojson_sf(GeoData) # Parse GeoJSON data

mgeojson <- merge(geojson, df_pop, by.x = "adm1_name", by.y = "adm1_name") # merge data frames by district names

ondgeojson <- merge(mgeojson, df_ond, by.x = "adm1_name", by.y = "adm1_name") # merge data frames by district names
#final datafram contains population info, forecast info, and shape files info

# dataframe with 4 most at-r-sk districts: Mafeteng, Mohale’s Hoek, Thaba-Tseka, and Quthing
four_ondgeojson <- ondgeojson %>%
  filter(adm1_name %in% c("Mafeteng", "Mohale's Hoek", "Thaba Tseka", "Quthing"))
```

```{r Lesotho Map Colors}
# break up population numbers into 5 sections and assign 5 colors
breaks <- quantile(mgeojson$Total, probs = c(0, 0.2, 0.4, 0.6, 0.8, 1))
colors <- c("lightblue", "aquamarine", "cyan", "darkcyan", "darkslategray")
#colors <- c("gold", "orange", "orangered", "red", "darkred")
#colors <- c("darkseagreen1", "palegreen", "seagreen3", "seagreen4", "darkgreen")

# Create a factor with colors based on quantiles (will add new column and assign color)
mgeojson$ColorFactor <- cut(mgeojson$Total, breaks = breaks, labels = colors[1:5], include.lowest = TRUE)

# create a legend and labels 
# Population
legend_colors <- c("lightblue", "aquamarine", "cyan", "darkcyan", "darkslategray")
    legend_labels <- c("Low Population", "MediumLow Population", "Medium Population","MediumHigh Population", "High Population")

#Forecast
```

```{r Lesotho OND Data Colors}
# break up forecast numbers into 5 sections and assign 5 colors
fcst_breaks <- c(40, 45, 50, 55, 60, 65)
fcst_colors <- c("darkred", "red", "orangered", "orange", "gold")

# Create a factor with colors based on divisions (will add new column and assign color)
ondgeojson$ColorFcst <- cut(ondgeojson$RainFcstV2, breaks = fcst_breaks, labels = fcst_colors[1:5], include.lowest = TRUE)

```

```{r Charts}
# POPULATION CHART
#library(viridis)

# Read the CSV data
pop_data <- read.csv("lesotho_pop_short1.csv")

# Create a bar chart to visualize the total population by district
ggplot(pop_data, aes(x = adm1_name, y = Total, fill = adm1_name)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Population by District in Lesotho",
    x = "District",
    y = "Total Population"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_viridis_d() +
  #scale_fill_discrete(name = "District") +
  guides(fill = 'none') +
  scale_y_continuous(breaks = seq(0, max(pop_data$Total), by = 50000), labels = scales::comma_format())
```

```{r Gantt Chart Setup}
df <- as.data.frame(rbind(
    c("Seasonal Impact", "Season", '2023-10-01', '2023-12-31', 'LMS'),
    c("Seasonal Impact", "Impact 1", '2023-11-01', '2023-12-31', 'LMS'),
    c("Seasonal Impact", "Impact 2", '2023-12-01', '2023-12-31', 'WASCO'),
    c("Seasonal Impact", "Impact 3", '2023-12-01', '2023-12-31', 'WASCO'),
    c("Seasonal Impact", "Impact 4", '2023-10-01', '2023-12-31', 'WASCO'),
    c("Forecast Triggers", "Readiness Trigger (OND)", '2023-07-01', '2023-09-30', 'LMS'),
    c("Forecast Triggers", "Readiness Trigger (DJF)", '2023-09-01', '2023-12-31', 'WASCO'),
    c("Forecast Triggers", "Activation Trigger (OND)", '2023-08-01', '2023-09-30', 'WASCO'),
    c("Forecast Triggers", "Activation Trigger (DJF)", '2023-10-01', '2023-11-30', 'LMS'),
    c("Anticipatory Actions", "Intervention 1", '2023-08-01', '2024-05-31', 'LMS'),
    c("Anticipatory Actions", "Intervention 2", '2023-08-01', '2024-05-31', 'LMS'),
    c("Anticipatory Actions", "Intervention 3", '2023-08-01', '2024-05-31', 'MAFSN'),
    c("Anticipatory Actions", "Intervention 4", '2023-08-01', '2024-05-31', 'WFP'),
    c("M&E", "Outcome", '2024-05-01', '2024-05-31', 'WFP'),
    c("M&E", "After Action Review", '2024-06-01', '2024-06-30', 'WFP'),
    c("M&E", "Final Report", '2024-07-01', '2024-08-31', 'WFP')
    )) %>%
  select("category" = 1, "task" = 2, "start" = 3, "end" = 4, "owner" = 5) %>%
  mutate(category = (factor(category, levels = unique(category))),
         task = fct_rev(factor(task, levels = unique(task))),
         start = as.Date(start), 
         end = as.Date(end)) %>%
  mutate(lab_pos = start) %>%
  pivot_longer(3:4, names_to = "variable", values_to = "value")

df$date <- as.Date(df$value)

# bar colors
get_category_colors <- function(num_categories) {
  return(viridis(num_categories))
}
# unique categories
num_categories <- length(unique(df$category))
# Generate colors 
bar_colors <- get_category_colors(num_categories)
# Map colors to the categories 
df$color <- bar_colors[match(df$category, unique(df$category))]
#bar_colors <- c("LMS" = "pink", "WASCO" = "aquamarine", "DMA" = "green", "RWS" = "orange", "MAFSN" = "red", "WFP" = "skyblue")
```


```{r Dashboard UI Inputs}
#header <- dashboardHeader()

# add sections to the sidebar
# can change name, icon, and add a label
sidebar <- dashboardSidebar(
    sidebarMenu(
      menuItem("Dashboard", tabName = "dashboard", icon = icon("house")),
      menuItem("Additional Data", icon = icon("th"), tabName = "data", badgeLabel = "label", badgeColor = "teal"),
      menuItem("Geographic Information", icon = icon("globe"), tabName = "table"),
      menuItem("Guide", icon = icon("list"), tabName = "guide")
    )
  )

# build dashboard body and assign outputs to a section on the sidebar
body <- dashboardBody(
      #tags$style(type = "text/css", "html, body {width:100%; height:100%}"),
  tabItems(
    tabItem(tabName = "dashboard", #assign section
      fluidRow(column(width = 9, #output width
      box(title = tags$strong("Lesotho Drought Forecast", style = "font-size: 23px;"), width = NULL, leafletOutput("lesotho_map", height = 500),
            actionButton("reset_map_button", "Reset Map")),
      ),
      column(width = 3,
       box(title = "Map Viewing Options", width = NULL, height = 500,
        uiOutput("lesotho_level"),
        selectInput("Select_Level", # create a dropdown menu for user to select input
              label = "Mode", 
              choices = c("National" = 1, # still need to set national view by removing district lines & labels
                          "District" = 2),
              selected = 2 # the default option to "District"
  ),
        uiOutput("lesotho_month"),
        selectInput("Select_Month", # create a dropdown menu for user to select input
              label = "Month", 
              choices = c("June" = 1,
                          "July" = 2, 
                          "August" = 3),
              selected = 1 # set the default option to "June"
  ),
  uiOutput("lesotho_forecast"),
        selectInput("Trigger_Level", # create a dropdown menu for user to select input
              label = "Severity", 
              choices = c("Mild" = 1,
                          "Moderate" = 2, 
                          "Severe" = 3),
              selected = 1 # set the default option to "Mild"
),

  p(class = "text-muted",
          HTML(paste("Mild: 35%", "<br>",
             "Moderate: 25%", "<br>",
             "Severe: 15%"))
          ),

  checkboxInput("Trigger_Input", HTML('<b>Show Triggered</b>'), value = FALSE, width = NULL),
  p(class = "text-muted",
         HTML(paste('<span style="color: red;">Drought Hazard Triggered</span>', "<br>",
             '<span style="color: green;">No Drought Hazard Triggered</span>'))
          )
      ),

),
      fluidRow(column(width = 12,
        box(title = "", width = NULL, height = 700, plotlyOutput("fig"))),
        #column(width = 5,
        #box(title = "Graph2", width = NULL, height = 500))
      )
    )),
    tabItem(tabName = "data",
      fluidRow(column(width = 9,
        box(title = "", width = NULL, height = 500, plotOutput("population_chart")),
      ))
    ),
  tabItem(tabName = "table",
      fluidRow(column(width = 10,
        box(title = "At-Risk Districts", width = NULL, tabPanel("Table", dataTableOutput("district_table"), height = 500))
        ))
    ),
    tabItem(tabName = "guide",
      fluidRow(column(width = 12,
        box(title = "Supporting Materials", width = NULL, height = 500),
      fluidRow(column(width = 12,
        box(title = "FAQ", width = NULL, height = 500, uiOutput("faqText")))
      )
      ))
    )
))
#dashboardPage(header, sidebar, body)
```

```{r Dashboard UI + Server}
#library(geojsonio)

# add header, sidebar, and body inputs to ui
ui <- dashboardPage(
  dashboardHeader(title = "Lesotho Dashboard"),
  sidebar,
  body
)



#build server
server <- function(input, output, session) {

# Build reactive user input for forecast viewing  
 selected_severity <- reactive({
    severity_level <- input$Trigger_Level
    month_select <- input$Select_Month
    if (severity_level == 1) {
      ondgeojson <- ondgeojson[ondgeojson$TriggerLevel == "mild", ]
    } else if (severity_level == 2) {
      ondgeojson <- ondgeojson[ondgeojson$TriggerLevel == "moderate", ]
    } else if (severity_level == 3) {
      ondgeojson <- ondgeojson[ondgeojson$TriggerLevel == "severe", ]
    } else {
      ondgeojson <- ondgeojson
    }
    
     if (month_select == 1) {
      ondgeojson <- ondgeojson[ondgeojson$Month == "June", ]
    } else if (month_select == 2) {
      ondgeojson <- ondgeojson[ondgeojson$Month == "July", ]
    } else if (month_select == 3) {
      ondgeojson <- ondgeojson[ondgeojson$Month == "August", ]
    } else {
      ondgeojson <- ondgeojson
    }
    
    ondgeojson$ColorFcst <- cut(ondgeojson$RainFcstV2, 
                       breaks = c(25, 30, 35, 40, 45, 50, 55, 60, 65, 70), 
                       labels = c("#1b0c41", "#4a0c6b", "#781c6d", "#a52c60", "#cf4446", "#ed6925", "#fb9b06", "#f7d13d", "#fcffa4"),
                       include.lowest = TRUE)

    return(ondgeojson)
  })
 
# Reactive viewing based on "Show Triggered" selection
trigger_show <- reactive({
    select_trigger <- input$Trigger_Input
    four_ondgeojson$ColorTrig <- ifelse(select_trigger, ifelse(four_ondgeojson$triggered == "yes", "red", "green"), "transparent")
  
  return(four_ondgeojson)
})

# Build Lesotho map
  output$lesotho_map <- renderLeaflet({ 
  #filtered_data <- selected_severity()
    leaflet() %>% setView(lng = 28.2336, lat = -29.6091, zoom = 7.5) %>% # set center coordinates and zoom for initial view
      addTiles() %>% # insert shape files to add district boundaries
      addGeoJSON(GeoData, weight = 1, color = "black", fill = FALSE) %>%
      addLabelOnlyMarkers(data = df_lab, ~Long, ~Lat, label = ~Name, # add district labels
      labelOptions = labelOptions(noHide = T, textsize = "9px", direction = "center", style = list(
        "color" = "black", "font-weight" = "bold", "background" = "transparent", "border" = "none", "box-shadow" = "none"))) %>%
      
      # add hover feature --> district boundaries highlighted when cursor hovers
      addPolygons(data = selected_severity(), color = "#444444", weight = 1, smoothFactor = 0.5,
      opacity = 1.0, fillOpacity = 0.77,
      fillColor = ~ColorFcst, # Mafeteng, Mohale’s Hoek, Thaba-Tseka, and Quthing most at-risk
      highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE)) %>% 
      
      # add fill based on "Show Triggered" Input
      addPolygons(data = trigger_show(), color = "#444444", weight = 1, smoothFactor = 0.5,
      opacity = 1.0, fillOpacity = 0.77,
      fillColor = ~ColorTrig, # Mafeteng, Mohale’s Hoek, Thaba-Tseka, and Quthing most at-risk
      highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE))
      
      # add legend
      #addLegend(
      #position = "bottomright",  # adjust position
      #colors = legend_colors,
      #labels = legend_labels,
      #title = "Population Legend (Test)"
    #) 
  })
  
  # function to reset map back to original view
  observeEvent(input$reset_map_button, {
    leafletProxy("lesotho_map") %>% setView(lng = 28.2336, lat = -29.6091, zoom = 7.5)
    #updateSelectInput(session, "Trigger_Level", selected = 1)
  })
  
# Insert Gantt Chart code

output$fig <- renderPlotly({
    # Your ggplot code goes here
    p <- ggplot() +
      geom_line(data=df, mapping=aes(x=fct_rev(fct_inorder(task)), y=date, color=category), size=4, show.legend = FALSE) +
      geom_hline(yintercept=as.Date("2023-01-01"), color="black", linetype="dashed") +
      coord_flip() +
      scale_y_date(date_breaks = "1 month", labels = scales::date_format("%b")) +
      scale_color_manual(values = bar_colors) +
      scale_x_discrete(labels = scales::date_format("%b")) +
      labs(title="Lesotho Anticipatory Action Timeline", face = "bold",
           x = "",
           y = "Month",
           color = "Owner") +
      facet_grid(category ~ ., space = "free_y", scales = "free_y", switch = "both") +
      theme_bw() +
      theme(
        axis.text.x = element_text(angle = 90, size = 9, family = "Helvetica"),
        axis.text.y = element_text(size = 9, family = "Helvetica", color = "black"),
        panel.grid.minor = element_line(color = "white", linewidth = 0.5),
        strip.background = element_blank(),
        strip.text.y = element_text(angle = 0, hjust = 1),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5, family = "Helvetica", size = 16, face = "bold"),
        plot.margin = margin(t = 1, r = 1, b = 1, l = 1, unit = "cm")

      )
    
    # remove viewing option included with plotly
    ggplotly(p) %>% 
    config(displayModeBar = FALSE) %>% 
    layout(margin = list(l = 150, r = 150, b = 50, t = 40), height = 500) 
    
  })

output$district_table <- renderDataTable({
        df_target_areas
    })
  
output$faqText <- renderUI({
  HTML("<p><b>What is the map displaying?</b> The map which appears under the dashboard tab displays Lesotho's districts and forecasted rainfall. The 'Month' option allows for the selection of either the June, July or August forecast. The 'Severity' option allows for the selection of either Mild, Moderate, or Severe severeity. Selecting the 'Show Triggered' checkbox shows whether the most at-risk districts (Mafeteng, Mohale's Hoek, Quthing, and Thaba-Tseka) are forecasted to have a drought (indicated by bold red color).
       <p><b>What is the Gantt Chart displaying?</b> The Gantt Chart shows the timeline of.
       <p> <b>What is the rainfall graph displaying?</b> .
       <p> <b>How do I...??</b> .
       ")
})

output$population_chart <- renderPlot({
    ggplot(pop_data, aes(x = adm1_name, y = Total, fill = adm1_name)) +
      geom_bar(stat = "identity") +
      labs(
        title = "Population by District in Lesotho",
        x = "District",
        y = "Total Population"
      ) +
      theme_minimal() +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1, color = "black"), 
        axis.text.y = element_text(color = "black"),
        plot.title = element_text(face = "bold", size = 23),  
        axis.title.x = element_text(face = "bold"), 
        axis.title.y = element_text(face = "bold")) +      
      scale_fill_viridis_d() +
      guides(fill = 'none') +
      scale_y_continuous(breaks = seq(0, max(pop_data$Total), by = 50000), labels = scales::comma_format())
  })
  
}


shinyApp(ui, server)
#shiny::runApp("~/Desktop/Columbia/Fall 23")
```



```{r Population Fill}
server <- function(input, output) {
  output$lesotho_map <- renderLeaflet({
    leaflet() %>% setView(lng = 28.2336, lat = -29.6091, zoom = 7) %>%
      addTiles() %>%
      addGeoJSON(GeoData, weight = 1, color = "black", fill = FALSE) %>%
      addLabelOnlyMarkers(data = df_lab, ~Long, ~Lat, label = ~Name,
      labelOptions = labelOptions(noHide = T, textsize = "9px", style = list(
        "color" = "black", "font-style" = "bold"))) %>%
      addPolygons(data = mgeojson, color = "#444444", weight = 1, smoothFactor = 0.5,
      opacity = 1.0, fillOpacity = 0.5,
      fillColor = ~ColorFactor,
      highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE)) %>% 
      addLegend(
      position = "bottomright",  # Adjust position as needed
      colors = legend_colors,
      labels = legend_labels,
      title = "Population Legend (Test)"
    ) 
  })
}
```



## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

