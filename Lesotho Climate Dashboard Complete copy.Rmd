---
title: "Lesotho Climate Dashboard"
author: "Ashna"
date: "2023-10-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Libraries for data manipulation and visualization
library(base)         # Fundamental functions and datasets in R
library(readr)        # Reading and writing delimited text files
library(tidyr)        # Tools for data tidying
library(dplyr)        # Data manipulation
library(tidyselect)   # Tidy selection helpers
library(ggplot2)      # Grammar of graphics for plotting
library(forcats)      # Tools for working with categorical variables

# Libraries for building interactive web applications
library(shiny)        # Framework for creating web applications in R
library(leaflet)      # Interactive maps
library(tidygeocoder) # Geocoding (converting addresses to geographic coordinates)
library(ggmap)        # Tools for working with Google Maps and OpenStreetMap data
library(mapview)      # Interactive viewing of spatial data
library(sf)           # Simple Features for spatial data
library(geojsonio)   # Tools for working with GeoJSON data
library(htmltools)    # Tools for HTML generation
library(sp)           # Classes and methods for spatial data
library(geojsonsf)   # Conversion between GeoJSON and Simple Features
library(leaflet.extras) # Additional functionalities for leaflet package

# Libraries for building dashboard-like interfaces
library(shinydashboard) # Dashboard framework for Shiny applications

# Libraries for deployment and publishing
library(rsconnect)    # Deployment of Shiny applications
library(here)         # Helps manage file paths in projects

# Libraries for interactive and dynamic plotting
library(plotly)       # Interactive plots

# Additional visualization-related libraries
library(viridis)      # Color palettes for data visualization
library(viridisLite)  # Subset of the viridis color palette
library(fresh)        # Themes and palettes for ggplot2
library(tableHTML)    # Creation of HTML tables with CSS styling

# Citattion for ggmap
#D. Kahle and H. Wickham. ggmap: Spatial Visualization with ggplot2. The R Journal, 5(1),
#  144-161. URL http://journal.r-project.org/archive/2013-1/kahle-wickham.pdf
```

```{r Load Necessary Dataframes}

# Load Population Information (districts, populations, coordinates)
df_pop <- read.csv(here("lesotho_pop_short1.csv"))

# Load Forecasted Rainfall Information
df_ond <- read.csv(here("LesothoONDData.csv"))

# add column to indicate whether drought was triggered
df_ond <- df_ond %>% 
  mutate(triggered = case_when(
    RainFcstV2 >= FrcstThreshold ~ "yes",
    RainFcstV2 < FrcstThreshold ~ "no")) 

# Load in dataframe containing the 4 at-risk districts, their councils, and geographic zones
df_target_areas <- read.csv('target_areas.csv', check.names=FALSE)

# Load in Organization Information
df_organizations <- read.csv("org_name.csv")

# Load in severity levels information
df_severity_levels <- read.csv("lesotho_severity_forecast.csv", check.names=FALSE)


```

```{r Lesotho Map Setup}

# Create labels for each district name for the main map
df_lab <- data.frame(
  Name = c("Quthing", "Mohale's Hoek", "Qacha's Nek", "Mafeteng", "Maseru", "Thaba-Tseka", "Mokhotlong", "Berea", "Leribe", "Butha-Buthe"),
# coordinates where labels will be
  Lat = c(-30.413616, -30.127431, -29.964429, -29.757574, -29.565642, -29.5333, -29.2885, -29.2069, -29.018983, -28.823041),
  Long = c(27.970415, 27.668363, 28.701420, 27.378837, 27.796710, 28.6, 29.0656, 27.878, 28.283234, 28.611562)
)

# Load in shapefiles for district boundaries
GeoData <- readLines(here("mygeodata_merged.json")) %>% 
  paste(collapse = "\n") 

geojson <- geojsonsf::geojson_sf(GeoData) # Parse GeoJSON data

mgeojson <- merge(geojson, df_pop, by.x = "adm1_name", by.y = "adm1_name") # merge data frames by district names

ondgeojson <- merge(mgeojson, df_ond, by.x = "adm1_name", by.y = "adm1_name") # merge data frames by district names
#final dataframe contains population info, forecast info, and shape files info

# filtered dataframe with 4 most at-r-sk districts: Mafeteng, Mohaleâ€™s Hoek, Thaba-Tseka, and Quthing
four_ondgeojson <- ondgeojson %>%
  filter(adm1_name %in% c("Mafeteng", "Mohale's Hoek", "Thaba Tseka", "Quthing"))
```

```{r Population Chart Setup}
# Load in population information
pop_data <- read.csv("lesotho_pop_short1.csv")

# population chart with only at-risk districts
pop_data_risk <- subset(pop_data, adm1_name %in% c("Mafeteng", "Mohale's Hoek", "Thaba Tseka", "Quthing"))
```

```{r Main Page Gantt Chart Setup}

# Create dataframe for the main Gantt Chart (using Annex 1 - AA Timeline from AAP Template)
df_main <- as.data.frame(rbind(
    c("Seasonal Impact", "Season", '2023-10-01', '2023-12-31', 'Season Start', "1"),
    c("Seasonal Impact", "Season", '2024-01-01', '2024-03-31', 'Mid/Peak Season', "2"),
    c("Seasonal Impact", "Season", '2024-04-01', '2024-05-31', 'Harvest', "3"),
    
    c("Seasonal Impact", "Impact 1", '2023-11-01', '2023-12-31', 'Food Insecurity', "4"),
    c("Seasonal Impact", "Impact 2", '2023-12-01', '2023-12-31', 'Disease Outbreak', "5"),
    c("Seasonal Impact", "Impact 3", '2023-12-01', '2023-12-31', 'Water Scarcity', "6"),
    c("Seasonal Impact", "Impact 4", '2023-10-01', '2023-12-31', 'Loss of Livestock', "7"),
    
    c("Forecast Triggers", "Readiness Trigger (OND)", '2023-07-01', '2023-09-30', 'LMS & IRI', "8"),
    c("Forecast Triggers", "Readiness Trigger (DJF)", '2023-09-01', '2023-12-31', 'LMS & IRI', "9"),
    c("Forecast Triggers", "Activation Trigger (OND)", '2023-08-01', '2023-09-30', 'LMS & IRI', "10"),
    c("Forecast Triggers", "Activation Trigger (DJF)", '2023-10-01', '2023-11-30', 'LMS & IRI', "11"),
    
    c("Anticipatory Actions", "Intervention 1", '2023-08-01', '2023-08-30', 'DMA, Min. of Health, SD, MAFSN, DRWS', "12"),
    c("Anticipatory Actions", "Intervention 1", '2023-09-01', '2024-01-31', 'DMA, Min. of Health, SD, MAFSN, DRWS', "13"),
    c("Anticipatory Actions", "Intervention 1", '2024-02-01', '2024-03-31', 'DMA, Min. of Health, SD, MAFSN, DRWS', "14"),
    
    c("Anticipatory Actions", "Intervention 2", '2023-08-01', '2023-08-30', 'SD, MAFSN, MFRSWC, DRWS, Min. of Health', "15"),
    c("Anticipatory Actions", "Intervention 2", '2023-09-01', '2024-01-31', 'SD, MAFSN, MFRSWC, DRWS, Min. of Health', "16"),
    c("Anticipatory Actions", "Intervention 2", '2024-02-01', '2024-03-31', 'SD, MAFSN, MFRSWC, DRWS, Min. of Health', "17"),
    
    c("Anticipatory Actions", "Intervention 3", '2023-08-01', '2023-08-30', 'SD, MAFSN, MFRSWC, DRWS, Min. of Health', "18"),
    c("Anticipatory Actions", "Intervention 3", '2023-09-01', '2024-01-31', 'SD, MAFSN, MFRSWC, DRWS, Min. of Health', "19"),
    c("Anticipatory Actions", "Intervention 3", '2024-02-01', '2024-03-31', 'SD, MAFSN, MFRSWC, DRWS, Min. of Health', "20"),
    
    c("Anticipatory Actions", "Intervention 4", '2023-08-01', '2023-10-31', 'SD, MAFSN, WFP, MFRSWC, Min. of Health', "21"),
    c("Anticipatory Actions", "Intervention 4", '2023-11-01', '2024-01-31', 'SD, MAFSN, WFP, MFRSWC, Min. of Health', "22"),
    c("Anticipatory Actions", "Intervention 4", '2024-02-01', '2024-03-31', 'SD, MAFSN, WFP, MFRSWC, Min. of Health', "23"),
    
    c("M&E", "Outcome", '2024-05-01', '2024-05-31', 'WFP', "24"),
    c("M&E", "After Action Review", '2024-06-01', '2024-06-30', 'WFP', "25"),
    c("M&E", "Final Report", '2024-07-01', '2024-08-31', 'WFP', "26")
    )) %>%
  select("Category" = 1, "Task" = 2, "start" = 3, "end" = 4, "Owner" = 5, "serial" = 6) %>%
  mutate(Category = (factor(Category, levels = unique(Category))),
         #Owner = fct_rev(factor(Owner, levels = unique(Owner))),
         serial = fct_rev(factor(serial, levels = unique(serial))),
         start = as.Date(start), 
         end = as.Date(end)) %>%
  mutate(lab_pos = start) %>%
  pivot_longer(3:4, names_to = "variable", values_to = "value")

df_main$date <- as.Date(df_main$value)

# bar colors
get_category_colors <- function(num_categories) {
  return(viridis(num_categories))
}
# unique categories
num_categories <- length(unique(df_main$Category))
# Generate colors 
bar_colors <- get_category_colors(num_categories)
# Map colors to the categories 
df_main$color <- bar_colors[match(df_main$Category, unique(df_main$Category))]

# colors based on owner
#bar_colors <- c("LMS" = "pink", "WASCO" = "aquamarine", "DMA" = "green", "RWS" = "orange", "MAFSN" = "red", "WFP" = "skyblue", "LMS & IRI" =)
```

```{r Anticipatory Action Gantt Chart Setup}

# Create Dataframe for the Anticipatory Actions Gantt Chart (using Annex 3 - Readiness Measures from AAP Template)
df_aa <- as.data.frame(rbind(
    c("General Readiness Actions", "1", "General Readiness Action 1", '2023-08-01', '2023-08-31', 'DMA', "Convene a meeting with all relevant stakeholders to roll-out AA's"),
    c("General Readiness Actions", "2", "General Readiness Action 2", '2023-08-01', '2023-08-31', 'WFP', "Filing for funds release from WFP"),
    c("General Readiness Actions", "3", "General Readiness Action 3", '2023-08-01', '2023-08-31', 'DMA', "Targeting, verification and validation of beneficiary lists"),
    c("General Readiness Actions", "4", "General Readiness Action 3", '2023-08-01', '2023-08-31', 'SD', "Targeting, verification and validation of beneficiary lists"),
    c("General Readiness Actions", "5", "General Readiness Action 4", '2023-09-01', '2023-09-30', 'DMA', "Identification of Hotspots and mapping of distribution points"),
    c("General Readiness Actions", "6", "General Readiness Action 4", '2023-09-01', '2023-09-30', 'DRWS', "Identification of hotspots and mapping of distribution points"),
    c("General Readiness Actions", "7", "General Readiness Action 4", '2023-09-01', '2023-09-30', 'WASCO', "Identification of hotspots and mapping of distribution points"),
    c("General Readiness Actions", "8", "General Readiness Action 5", '2023-08-01', '2023-08-31', 'DA', "Inventory of available resources"),
    c("General Readiness Actions", "9", "General Readiness Action 6 ", '2023-08-01', '2023-08-31', 'DMA', "Inventory of available resources"),
    
    c("Anticipatory Action 1", "10", "Anticipatory Action 1A", '2023-08-01', '2023-09-30', 'DMA', "Stakeholder coordination meeting for development of EW messages"),
    c("Anticipatory Action 1", "11", "Anticipatory Action 1B", '2023-08-01', '2023-08-31', 'DMA', "Identification and engagement of dissemination platforms"),

    c("Anticipatory Action 2", "12", "Anticipatory Action 2A", '2023-09-01', '2023-09-31', 'RWS', "Update and validate targeted hotspots"),
    c("Anticipatory Action 2", "13", "Anticipatory Action 2A", '2023-09-01', '2023-09-31', 'WASCO', "Update and validate targeted hotspots"),
    c("Anticipatory Action 2", "14", "Anticipatory Action 2A", '2023-09-01', '2023-09-31', 'DWA', "Update and validate targeted hotspots"),
    c("Anticipatory Action 2", "15", "Anticipatory Action 2B", '2023-10-01', '2023-11-30', 'DMA', "Relevant stakeholder coordination meetings"),
    c("Anticipatory Action 2", "16", "Anticipatory Action 2C", '2023-08-01', '2023-09-30', 'DMA', "Sensitisation of communities."),
    c("Anticipatory Action 2", "17", "Anticipatory Action 2D", '2023-09-01', '2023-09-30', 'Min. of Health', "Provide specifications for appropriate purification tablets"),
    c("Anticipatory Action 2", "18", "Anticipatory Action 2E", '2023-08-01', '2023-08-31', 'WFP', "Procurement and delivery of Plastic water tanks, fittings"),
    c("Anticipatory Action 2", "19", "Anticipatory Action 2E", '2023-08-01', '2023-08-31', 'DMA', "Procurement and delivery of Plastic water tanks, fittings"),
    c("Anticipatory Action 2", "20", "Anticipatory Action 2F", '2023-08-01', '2023-08-31', 'DMA', "Engage beneficiaries to work on water sources rehabilitations [CCT]"),
    
    c("Anticipatory Action 3", "21", "Anticipatory Action 3A", '2023-08-01', '2023-08-31', 'MAFSN', "Provide specifications and quantities for Agric inputs"),
    c("Anticipatory Action 3", "22", "Anticipatory Action 3B", '2023-08-01', '2023-09-30', 'WFP', "Procure inputs for targeted beneficiaries"),
    c("Anticipatory Action 3", "23", "Anticipatory Action 3C", '2023-08-01', '2023-09-30', 'MAFSN', "Sensitise targeted beneficiaries on use of inputs"),
    c("Anticipatory Action 3", "24", "Anticipatory Action 3C", '2023-08-01', '2023-09-30', 'Dept. of Range', "Sensitise targeted beneficiaries on use of inputs"),
    
    c("Anticipatory Action 4", "25", "Anticipatory Action 4A", '2023-09-01', '2023-09-30', 'DMA', "Update transfer value & modalities"),
    c("Anticipatory Action 4", "26", "Anticipatory Action 4B", '2023-09-01', '2023-09-30', 'DMA', "Provision and verification of beneficiaries"),
    c("Anticipatory Action 4", "27", "Anticipatory Action 4B", '2023-09-01', '2023-09-30', 'SD', "Provision and verification of beneficiaries"),
    c("Anticipatory Action 4", "28", "Anticipatory Action 4C", '2023-09-01', '2023-09-30', 'WFP', "Engage financial service providers for CBT")
    )) %>%
  select("Category" = 1, "serial" = 2, "Task" = 3, "start" = 4, "end" = 5, "Owner" = 6, "Description" = 7) %>%
  mutate(Category = (factor(Category, levels = unique(Category))),
         serial = fct_rev(factor(serial, levels = unique(serial))),
         #task = fct_rev(factor(task, levels = unique(task))),
         start = as.Date(start), 
         end = as.Date(end)) %>%
  mutate(lab_pos = start) %>%
  pivot_longer(4:5, names_to = "variable", values_to = "value")

df_aa$date <- as.Date(df_aa$value)

# bar colors
get_category_colors <- function(num_categories) {
  return(viridis(num_categories))
}
# unique categories
num_categories <- length(unique(df_aa$Category))
# Generate colors 
bar_colors <- get_category_colors(num_categories)
# Map colors to the categories 
df_aa$color <- bar_colors[match(df_aa$Category, unique(df_aa$Category))]
```

```{r Dataframe for Anticipatory Action Table}
df_aa_rev <- df_aa %>%
  pivot_wider(names_from = variable, values_from = value) %>%
  mutate(start = as.Date(start),
         end = as.Date(end)) %>%
  select(-date) %>%
  group_by(Category, serial, Task, color) %>%
  summarize(
    start = min(start, na.rm = TRUE),
    end = max(end, na.rm = TRUE),
    Owner = first(Owner),
    Description = first(Description)
  )

```

```{r Rainfall Graph Data}

# Create dataframe for the rainfall graph (using ENACTS rainfall data)
rain_data <- data.frame(
    Year = c(2023, 2022, 2021, 2020, 2019, 2018, 2017, 2016, 2015, 2014, 2013, 2023, 2022, 2021, 2020, 2019, 2018, 2017, 2016, 2015, 2014, 2013, 2023, 2022, 2021, 2020, 2019, 2018, 2017, 2016, 2015, 2014, 2013, 2023, 2022, 2021, 2020, 2019, 2018, 2017, 2016, 2015, 2014, 2013),
    Month = c(2023.7, 2022.7, 2021.7, 2020.7, 2019.7, 2018.7, 2017.7, 2016.7, 2015.7, 2014.7, 2013.7, 2023.6, 2022.6, 2021.6, 2020.6, 2019.6, 2018.6, 2017.6, 2016.6, 2015.6, 2014.6, 2013.6, 2023.8, 2022.8, 2021.8, 2020.8, 2019.8, 2018.8, 2017.8, 2016.8, 2015.8, 2014.8, 2013.8, 2023.9, 2022.9, 2021.9, 2020.9, 2019.9, 2018.9, 2017.9, 2016.9, 2015.9, 2014.9, 2013.9),
    RainHistory = c(0, 0, 0, 312.9, 182.1, 98.4, 225.2, 216.8, 74.6, 346.5, 310.2, 0, 0, 0, 312.9, 182.1, 98.4, 225.2, 216.8, 74.6, 346.5, 310.2, 0, 0, 0, 312.9, 182.1, 98.4, 225.2, 216.8, 74.6, 346.5, 310.2, 0, 0, 0, 312.9, 182.1, 98.4, 225.2, 216.8, 74.6, 346.5, 310.2),
    RainForecast = c(60.3, 15.6, 20.4, 27.2, 41.9, 48, 26.9, 16.5, 51.8, 35.9, 15.9, 48.2, 18, 32.6, 21.1, 34.5, 34.3, 22.4, 17.1, 41.5, 33.2, 24.8, 43.7, 23.3, 24.2, 20.7, 36.5, 42, 26.2, 17.4, 38, 27, 20.5, 0, 17.8, 22.1, 24.2, 52.9, 35.8, 14.9, 17.6, 35.7, 19.3, 22)
  )
  
  rain_data<-rain_data[order(rain_data$Year, rain_data$Month),]
```


```{r Create Dashboard Theme}
#library(fresh)
my_theme = create_theme(
  adminlte_color(
    light_blue = "#4898a8" # choose color for the top and side bars
  )
)
```


```{r Dashboard UI Inputs}

# add tabs/sections to the sidebar
# can change name, icon, and add a label
sidebar <- dashboardSidebar(
    sidebarMenu(
      menuItem("Dashboard", tabName = "dashboard", icon = icon("house")),
      menuItem("Anticipatory Actions", icon = icon("th"), tabName = "actions"),
      menuItem("Forecasting Rainfall", icon = icon("droplet"), tabName = "rain"),
      menuItem("At-Risk Districts", icon = icon("globe"), tabName = "risk"),
      menuItem("Additional Data", icon = icon("chart-simple"), tabName = "data"),
      menuItem("Guide", icon = icon("list"), tabName = "guide")
    ),
    tags$style(HTML(".main-sidebar { margin-left: 0; }"))
  )

# NOTE: add badgeLabel = "your_label_here" within each menuItem to add a custom label to the tab name and add badgeColor = "color" to change the color of the label  (ie. badgeLabel = "new", badgeColor = "teal")

# build dashboard body and assign outputs to a section on the sidebar
body <- dashboardBody(use_theme(my_theme),
      #tags$style(type = "text/css", "html, body {width:100%; height:100%}"),
  tabItems(
    tabItem(tabName = "dashboard", #assign section
      fluidRow(column(width = 9, #output width
      box(title = tags$strong("Lesotho Drought Forecast", style = "font-size: 23px;"), width = NULL, leafletOutput("lesotho_map", height = 500), # set output for main dashboard map (lesotho_map)
            actionButton("reset_map_button", "Reset Map")), # add option to reset map to original view
      ),
      column(width = 3, # build map viewing options
       box(title = tags$strong("Map Viewing Options", style = "font-size: 19px;"), width = NULL, height = 500,
        uiOutput("lesotho_level"),
        selectInput("Select_Level", # create a drop down menu for user to select viewing level
              label = "Mode", 
              choices = c("National" = 1, # still need to set national view by removing district lines & labels
                          "District" = 2),
              selected = 2 # the default option to "District"
  ),
        uiOutput("lesotho_month"),
        selectInput("Select_Month", # create a drop down menu for user to select forecasted month
              label = "Month", 
              choices = c("June" = 1,
                          "July" = 2, 
                          "August" = 3),
              selected = 1 # set the default option to "June"
  ),
  uiOutput("lesotho_forecast"),
        selectInput("Trigger_Level", # create a drop down menu for user to select severity level
              label = "Severity", 
              choices = c("Mild" = 1,
                          "Moderate" = 2, 
                          "Severe" = 3),
              selected = 1 # set the default option to "Mild"
),
  # add a legend for severity levels
  p(class = "text-muted",
          HTML(paste("Mild: 35%", "<br>",
             "Moderate: 25%", "<br>",
             "Severe: 15%"))
          ),
  # add option to see whether 4 most at-risk districts are triggered & legend
  checkboxInput("Trigger_Input", HTML('<b>Show Triggered</b>'), value = FALSE, width = NULL),
  p(class = "text-muted",
         HTML(paste('<span style="color: red;">Drought Hazard Triggered</span>', "<br>",
             '<span style="color: green;">No Drought Hazard Triggered</span>'))
          )
      ),

)),
       fluidRow(column(width = 12,
        box(title = "", width = NULL, height = 650, plotlyOutput("gantt1")) #, # add Gantt Chart to main dashbaord page
         #box(title = "Select Range", height = 200,
             # sliderInput(
             # inputId = "range",
             # label = "Range",
             # min = "2023-01-01",
             # max = "2024-12-31",
             # value = c(as.Date("2023-01-01"), as.Date("2024-12-31")))
 #)
 ),
#         # column(width = 3,
#         #   box(title = "Chart Viewing Options", width = NULL, height = 200,
#         #   uiOutput("selected_category"),
#         #   selectInput("categoryInput", "Select Category", choices = c("All", unique(df$category))) 
#         #       #selected = 1
#         #   ))
        ),
      fluidRow(column(width = 12,
        box(title = tags$strong("Anticipatory Action Implementation Organizations", style = "font-size: 19px;"), width = NULL, height = 700, tableOutput("organization_table1"))) # add table to describe organizations
        )
    ),
    tabItem(tabName = "actions",
      fluidRow(column(width = 12,
        box(title = "", width = NULL, height = 850, plotlyOutput("gantt2"))), # Add anticipatory actions Gantt Chart
        ),
      fluidRow(column(width = 12,
        box(title = tags$strong("Action Descriptions", style = "font-size: 19px;"), width = NULL, height = 500,
        selectInput("Action_Selection", # create a dropdown menu for user to select action type
              label = "Action Type", 
              choices = c("General Readiness Actions" = 1,
                          "Anticipatory Action 1" = 2, 
                          "Anticipatory Action 2" = 3,
                          "Anticipatory Action 3" = 4,
                          "Anticipatory Action 4" = 5),
              selected = 1), # set default selection to General Readiness Actions
        # selectInput("Owner_Selection", # create a dropdown menu for user to select input
        #       label = "Action Type", 
        #       choices = c("Select an Owner" = "",
        #                   "DMA" = 2, 
        #                   "WFP" = 3,
        #                   "SD" = 4,
        #                   "DRWS" = 5,
        #                   "WASCO" = 6,
        #                   "DA" = 7,
        #                   "RWS" = 8,
        #                   "Min. of Health" = 9,
        #                   "MAFSN" = 10,
        #                   "Dept. of Range" = 11),
        #       selected = "",
        #       multiple = TRUE),
        tableOutput("action_info"))) # select output
    ),
    fluidRow(column(width = 12,
        box(title = tags$strong("Anticipatory Action Implementation Organizations", style = "font-size: 19px;"), width = NULL, height = 700, tableOutput("organization_table2"))) # add table to describe organizations
        )
    ),
tabItem(tabName = "rain",
        fluidRow(column(width = 12,
        box(title = tags$strong("Forecasted vs. Measured Rainfall", style = "font-size: 23px;"), width = NULL, height = 500, plotlyOutput("rain_plot")) # add forecasted rainfall chart
      )),
      fluidRow(column(width = 12,
        box(title = tags$strong("Severity Levels", style = "font-size: 23px;"), width = NULL, height = 500, tableOutput("severity_table")) # add forecasted rainfall chart
      ))
      ),
tabItem(tabName = "data",
        fluidRow(column(width = 9,
        box(title = tags$strong("Lesotho Population by District", style = "font-size: 23px;"), width = NULL, height = 500, plotOutput("population_chart")), # add graph to show populations of districts
      ))
    ),
  tabItem(tabName = "risk",
      fluidRow(column(width = 6,
        box(title = tags$strong("At-Risk District Populations", style = "font-size: 23px;"), width = NULL, height = 500, plotOutput("population_chart_risk")), # add graph to show populations of at-risk districts
      ),
      column(width = 6, #output width
      box(title = tags$strong("At-Risk Districts", style = "font-size: 23px;"), width = NULL, leafletOutput("risk_map", height = 500), # add map showing at-risk districts
            actionButton("reset_riskmap_button", "Reset Map")), # add reset map view option
      )),
      fluidRow(column(width = 12,
        box(title = tags$strong("Council & Geographic Information", style = "font-size: 21px;"), width = 6, height = 450,
            selectInput("Risk_District_Selection", # create a dropdown menu for user to select input
              label = "Risk District", 
              choices = c("Mafeteng" = 1,
                          "Mohaleâ€™s Hoek" = 2, 
                          "Quthing" = 3,
                          "Thaba-Tseka" = 4),
              selected = 1),
            tableOutput("district_table")), # add table showing councils and geographic information of at-risk districts
        box(title = tags$strong("Geographic Zones", style = "font-size: 21px;"), width = 6, height = 500, imageOutput("lesotho_geozones"))
        ))
    ),
    tabItem(tabName = "guide",
      #fluidRow(column(width = 12,
        #box(title = "FAQ", width = NULL, height = 500, uiOutput("faqText"))) # omitted FAQ
      #),
      fluidRow(column(width = 12, # add section for supporting materials
        box(title = tags$strong("Supporting Materials", style = "font-size: 21px;"), width = NULL, height = 500, uiOutput("supporting_materials"))
      ))
    )
))
#dashboardPage(header, sidebar, body)
```

```{r Dashboard UI + Server}

# add header, sidebar, and body inputs to ui
ui <- dashboardPage(
  dashboardHeader(title = tags$div(HTML('<b style="font-size: 16px;">Lesotho Dashboard</b>')), #dashboard title
                  titleWidth = 500,
                  tags$li(class = "dropdown",
            tags$style(".main-header {max-height: 100px}"),
            tags$style(".main-header .logo {height: 50px;}"))),
  sidebar,
  body
) # NOTE: to make title longer and larger, omit dashboard theme



#build server
server <- function(input, output, session) {

# Build reactive user input for forecast viewing  
 selected_severity <- reactive({
    severity_level <- input$Trigger_Level # trigger level selection
    month_select <- input$Select_Month # month selection
    if (severity_level == 1) { # ie. if the input selected is 1 --> this corresponds to mild severity in the dataframe
      ondgeojson <- ondgeojson[ondgeojson$TriggerLevel == "mild", ]
    } else if (severity_level == 2) {
      ondgeojson <- ondgeojson[ondgeojson$TriggerLevel == "moderate", ]
    } else if (severity_level == 3) {
      ondgeojson <- ondgeojson[ondgeojson$TriggerLevel == "severe", ]
    } else {
      ondgeojson <- ondgeojson
    }
    
     if (month_select == 1) {
      ondgeojson <- ondgeojson[ondgeojson$Month == "June", ]
    } else if (month_select == 2) {
      ondgeojson <- ondgeojson[ondgeojson$Month == "July", ]
    } else if (month_select == 3) {
      ondgeojson <- ondgeojson[ondgeojson$Month == "August", ]
    } else {
      ondgeojson <- ondgeojson
    }
    
    ondgeojson$ColorFcst <- cut(ondgeojson$RainFcstV2, # set colors based on user inputs and forecasted drought
                       breaks = c(25, 30, 35, 40, 45, 50, 55, 60, 65, 70), 
                       labels = c("#1b0c41", "#4a0c6b", "#781c6d", "#a52c60", "#cf4446", "#ed6925", "#fb9b06", "#f7d13d", "#fcffa4"), # colors are taken from inferno palette
                       include.lowest = TRUE)

    return(ondgeojson)
  })
 
# Reactive viewing based on "Show Triggered" selection
trigger_show <- reactive({
    select_trigger <- input$Trigger_Input
    four_ondgeojson$ColorTrig <- ifelse(select_trigger, ifelse(four_ondgeojson$triggered == "yes", "red", "green"), "transparent")
  
  return(four_ondgeojson)
})

# Build main page Lesotho map
  output$lesotho_map <- renderLeaflet({ 
  #filtered_data <- selected_severity()
    leaflet() %>% setView(lng = 28.2336, lat = -29.6091, zoom = 7.5) %>% # set center coordinates and zoom for initial view
      addTiles() %>% # insert shape files to add district boundaries
      addGeoJSON(GeoData, weight = 1, color = "black", fill = FALSE) %>%
      addLabelOnlyMarkers(data = df_lab, ~Long, ~Lat, label = ~Name, # add district labels
      labelOptions = labelOptions(noHide = T, textsize = "9px", direction = "center", style = list(
        "color" = "black", "font-weight" = "bold", "background" = "transparent", "border" = "none", "box-shadow" = "none"))) %>% # edit district labels
      
      # add hover feature --> district boundaries highlighted when cursor hovers
      addPolygons(data = selected_severity(), color = "#444444", weight = 1, smoothFactor = 0.5,
      opacity = 1.0, fillOpacity = 0.77,
      fillColor = ~ColorFcst, 
      highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE)) %>% 
      
      # add fill based on "Show Triggered" Input
      addPolygons(data = trigger_show(), color = "#444444", weight = 1, smoothFactor = 0.5,
      opacity = 1.0, fillOpacity = 0.77,
      fillColor = ~ColorTrig, # Mafeteng, Mohaleâ€™s Hoek, Thaba-Tseka, and Quthing most at-risk
      highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE)) %>%
    
      # add legend
      addLegend(
      position = "bottomright",  # adjust position
      colors = c("#fcffa4", "#f7d13d", "#fb9b06", "#ed6925", "#cf4446", "#a52c60", "#781c6d", "#4a0c6b", "#1b0c41"),
      labels = c("25", "30", "35", "40", "45", "50", "55", "60", "65"),
      title = "Probability of </br> Threshold Excedence (%)",
      opacity = 0.77,
      labFormat = labelFormat(suffix = "%") # suffix is not currently working
    ) 
  })
  
  # function to reset map back to original view
  observeEvent(input$reset_map_button, {
    leafletProxy("lesotho_map") %>% setView(lng = 28.2336, lat = -29.6091, zoom = 7.5)
  })
  
# Insert Gantt Chart code

output$gantt1 <- renderPlotly({ # set ouptut name to gantt1
    p <- ggplot() +
      # Plot lines based on data from the dataframe df. It uses Task on the x-axis, date on the y-axis, colors by Category, and displays Owner information in the tooltip
      geom_line(data=df_main, mapping=aes(x=fct_rev(fct_inorder(Task)), y=date, color=Category, text = paste(Owner)), size=4, show.legend = FALSE) +
      # Add a horizontal dashed line at the date "2023-01-01"
      geom_hline(yintercept=as.Date("2023-01-01"), color="black", linetype="dashed") +
      coord_flip() + # Flips the x and y axes
      # Set the breaks and labels for the y-axis as monthly intervals
      scale_y_date(date_breaks = "1 month", labels = scales::date_format("%b")) +
      # Manually set the colors for Category using the bar_colors variable
      scale_color_manual(values = bar_colors) +
      # Format the x-axis as dates in abbreviated month format
      scale_x_discrete(labels = scales::date_format("%b")) +
      # Set the title and axis labels
      labs(title="Lesotho Anticipatory Action Timeline", face = "bold",
           x = "",
           y = "Month",
           color = "Owner") +
      # Facet the plot based on category
      facet_grid(Category ~ ., space = "free_y", scales = "free_y", switch = "both") +
      # Set theme elements like text size, font family, grid lines, legend position, and plot margins
      theme_bw() +
      theme(
        axis.text.x = element_text(angle = 90, size = 9, family = "Helvetica"),
        axis.text.y = element_text(size = 9, family = "Helvetica", color = "black"),
        panel.grid.minor = element_line(color = "white", linewidth = 0.5),
        strip.background = element_blank(),
        strip.text.y = element_text(angle = 0, hjust = 1, face = "bold"),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5, family = "Helvetica", size = 16, face = "bold"),
        plot.margin = margin(t = 1, r = 1, b = 1, l = 1, unit = "cm")

      )
    
    # Remove viewing option included with plotly
    ggplotly(p, tooltip = "text") %>% 
    config(displayModeBar = FALSE) %>% 
    layout(margin = list(l = 150, r = 150, b = 50, t = 40), height = 500, 
    xaxis = list(fixedrange = TRUE), # Remove zoom option for x-axis
    yaxis = list(fixedrange = TRUE),  # Remove zoom option for each y-axis category (4)
    yaxis2 = list(fixedrange = TRUE),
    yaxis3 = list(fixedrange = TRUE),
    yaxis4 = list(fixedrange = TRUE))
    
  })

#AA Gantt Chart
# Same code as above, but usinf df_aa
output$gantt2 <- renderPlotly({ # set ouptut name to gantt2
    p <- ggplot() +
      geom_line(data=df_aa, mapping=aes(x=fct_rev(fct_inorder(Task)), y=date, color=Category, text = paste(Owner)), size=3, show.legend = FALSE) +
      geom_hline(yintercept=as.Date("2023-01-01"), color="black", linetype="dashed") +
      coord_flip() +
      scale_y_date(date_breaks = "1 month", labels = scales::date_format("%b")) +
      scale_color_manual(values = bar_colors) +
      scale_x_discrete(labels = scales::date_format("%b")) +
      labs(title="Lesotho Readiness Measures & Anticipatory Action Timeline", face = "bold",
           x = "",
           y = "Month",
           color = "Owner") +
      facet_grid(Category ~ ., space = "free_y", scales = "free_y", switch = "both") +
      theme_bw() +
      theme(
        axis.text.x = element_text(angle = 90, size = 9, family = "Helvetica"),
        axis.text.y = element_text(size = 9, family = "Helvetica", color = "black"),
        panel.grid.minor = element_line(color = "white", linewidth = 0.5),
        strip.background = element_blank(),
        strip.text.y = element_text(angle = 0, hjust = 1, face = "bold"),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5, family = "Helvetica", size = 16, face = "bold"),
        plot.margin = margin(t = 1, r = 1, b = 0.1, l = 1, unit = "cm")

      )
    
    # remove viewing options included with plotly
    ggplotly(p, tooltip = "none") %>% 
    config(displayModeBar = FALSE) %>% 
    layout(margin = list(l = 150, r = 150, b = 50, t = 40), height = 700, 
    xaxis = list(fixedrange = TRUE),
    yaxis = list(fixedrange = TRUE),
    yaxis2 = list(fixedrange = TRUE),
    yaxis3 = list(fixedrange = TRUE),
    yaxis4 = list(fixedrange = TRUE),
    yaxis5 = list(fixedrange = TRUE))
    
  })

# create reactive viewing option for the Anticipatory Actions tab table
filtered_data <- reactive({
    action_select <- input$Action_Selection
    #owner_select <- input$Owner_Selection
    
    if (action_select == 1) { # ie. if the input selected is 1 --> this corresponds to General Readiness Actions in the dataframe
      df_aa_rev <- df_aa_rev[df_aa_rev$Category == "General Readiness Actions", ]
    } else if (action_select == 2) {
      df_aa_rev <- df_aa_rev[df_aa_rev$Category == "Anticipatory Action 1", ]
    } else if (action_select == 3) {
      df_aa_rev <- df_aa_rev[df_aa_rev$Category == "Anticipatory Action 2", ]
    } else if (action_select == 4) {
      df_aa_rev <- df_aa_rev[df_aa_rev$Category == "Anticipatory Action 3", ]
    } else if (action_select == 5) {
      df_aa_rev <- df_aa_rev[df_aa_rev$Category == "Anticipatory Action 4", ]
    } else {
      df_aa_rev <- df_aa_rev
    }

    # if (owner_select == 2) {
    #   df_aa_rev <- df_aa_rev[df_aa_rev$owner == "DMA", ]
    # } else if (owner_select == 3) {
    #   df_aa_rev <- df_aa_rev[df_aa_rev$owner == "WFP", ]
    # } else if (owner_select == 4) {
    #   df_aa_rev <- df_aa_rev[df_aa_rev$owner == "SD", ]
    # } else if (owner_select == 5) {
    #   df_aa_rev <- df_aa_rev[df_aa_rev$owner == "DRWS", ]
    # } else if (owner_select == 6) {
    #   df_aa_rev <- df_aa_rev[df_aa_rev$owner == "WASCO", ]
    # } else if (owner_select == 7) {
    #   df_aa_rev <- df_aa_rev[df_aa_rev$owner == "DA", ]
    # } else if (owner_select == 8) {
    #   df_aa_rev <- df_aa_rev[df_aa_rev$owner == "RWS", ]
    # } else if (owner_select == 9) {
    #   df_aa_rev <- df_aa_rev[df_aa_rev$owner == "Min. of Health", ]
    # } else if (owner_select == 10) {
    #   df_aa_rev <- df_aa_rev[df_aa_rev$owner == "MAFSN", ]
    # } else if (owner_select == 11) {
    #   df_aa_rev <- df_aa_rev[df_aa_rev$owner == "Dept. of Range", ]
    # } else {
    #   df_aa_rev <- df_aa_rev
    # }
    
    return(df_aa_rev)
  })

# render anticipatory actions table based on reactive input
output$action_info <- renderTable({
    selected_data <- filtered_data() %>%
      arrange(desc(row_number()))
    selected_data[, c("Task", "Owner", "Description")] # Only show Task, Owner, & Description
  })


# create reactive viewing option for the At-Risk Districts tab table
filtered_data1 <- reactive({
    district_select <- input$Risk_District_Selection
    
    if (district_select == 1) {
      df_target_areas <- df_target_areas[df_target_areas$District == "Mafeteng", ]
    } else if (district_select == 2) {
      df_target_areas <- df_target_areas[df_target_areas$District == "Mohale's Hoek", ]
    } else if (district_select == 3) {
      df_target_areas <- df_target_areas[df_target_areas$District == "Quthing", ]
    } else if (district_select == 4) {
      df_target_areas <- df_target_areas[df_target_areas$District == "Thaba-Tseka", ]
    } else {
      df_target_areas <- df_target_areas
    }

    return(df_target_areas)
  })


# render At-Risk Districts tab table
output$district_table <- renderTable({
    selected_data1 <- filtered_data1()# %>%
      #arrange(desc(row_number()))
    selected_data1[, c("Council", "Geographic Zone")] # Only show Council, & Geographic Zone
  })

# render organization information table for main page
output$organization_table1 <- renderTable({
        df_organizations
    })

# render organization information table for anticipatory actions tab
output$organization_table2 <- renderTable({
        df_organizations
    })

# render severity level table for forecasted rainfall tab
output$severity_table <- renderTable({
        df_severity_levels
    })

# Add Lesotho geographic zones image from AAP Template
output$lesotho_geozones <- renderImage({
    
    list(src = "lesotho_geozones.png",
         width = 500#,
         #height = 450)
    )
  }, deleteFile = F)

# FAQ Output (currently omitted in dashboard)
output$faqText <- renderUI({
  # <p> creates a new paragraph and <b> makes the enclosed text bold
  HTML("<p><b>What is the map displaying?</b> The map which appears under the dashboard tab displays Lesotho's districts and forecasted rainfall. The 'Month' option allows for the selection of either the June, July or August forecast. The 'Severity' option allows for the selection of either Mild, Moderate, or Severe severeity. Selecting the 'Show Triggered' checkbox shows whether the most at-risk districts (Mafeteng, Mohale's Hoek, Quthing, and Thaba-Tseka) are forecasted to have a drought (indicated by bold red color).
       <p><b>What is the Gantt Chart displaying?</b> The Gantt Chart shows the timeline of.
       <p> <b>What is the rainfall graph displaying?</b> .
       <p> <b>How do I...??</b> .
       ")
})

# Supporting Material Output 
# code template: <p><b><a href="URL_TO_DOCUMENT1" target="_blank">Text Output</a></b></p>
output$supporting_materials <- renderUI({
  HTML('<p><b><a href="https://docs.google.com/document/d/1NP68PkQjlqbKQcoe-_qG35HdL5FY4K-MuQTIzWrFkmg/edit" target="_blank">Dashboard Handoff Document</a></b></p>
  
        <p><b><a href="https://docs.google.com/document/d/1aniT56-fqGLNI07uPqzYHrtW9FsrIQm4/edit" target="_blank">Lesotho Simplified AAP Template</a></b></p>
        
        <p><b><a href="https://iridl.ldeo.columbia.edu/fbfmaproom2/lesotho-ond?mode=0&map_column=pnep-v2&season=season1&predictors=pnep-v2+rain&predictand=bad-years-ag&year=2023&issue_month=sep&freq=15&severity=0&include_upcoming=false&position=%5B-29.606%2C28.25625%5D&show_modal=false" target="_blank">OND Season Map Tool</a></b></p>
       ')
})

# build district population graph for Additional Information tab
output$population_chart <- renderPlot({
    # Using pop_data dataframe, x = district name, y = total population, fill by district
    ggplot(pop_data, aes(x = adm1_name, y = Total, fill = adm1_name)) +
      geom_bar(stat = "identity") + # Create a bar plot with actual values from Total column
      labs( # Set title, x-axis label, and y-axis label
        title = "",
        x = "District",
        y = "Total Population"
      ) +
      theme_minimal() + # Apply a minimal theme to the plot
      theme( # Customize axis and title appearance
        axis.text.x = element_text(angle = 45, hjust = 1, color = "black"), 
        axis.text.y = element_text(color = "black"),
        plot.title = element_text(face = "bold", size = 23),  
        axis.title.x = element_text(face = "bold", size = 15), 
        axis.title.y = element_text(face = "bold", size = 15)) +      
      scale_fill_manual(values = rev(viridisLite::mako(10))) + # Set fill colors for the bars using the viridisLite palette
      guides(fill = 'none') + # Remove the legend for fill
      # Set the y-axis breaks and labels
      scale_y_continuous(breaks = seq(0, max(pop_data$Total), by = 50000), labels = scales::comma_format())
  })

# At-risk districts population graph for At-Risk Districts tab
# Same code as above, but using a subsetted dataframe (pop_data_risk) to only show at-risk districts
output$population_chart_risk <- renderPlot({
    ggplot(pop_data_risk, aes(x = adm1_name, y = Total, fill = adm1_name)) +
      geom_bar(stat = "identity") +
      labs(
        #title = "At-Risk District Populations",
        x = "District",
        y = "Total Population"
      ) +
      theme_minimal() +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1, color = "black"), 
        axis.text.y = element_text(color = "black"),
        plot.title = element_text(face = "bold", size = 23),  
        axis.title.x = element_text(face = "bold", size = 15), 
        axis.title.y = element_text(face = "bold", size = 15)) +      
      scale_fill_manual(values = rev(viridisLite::mako(10))) +
      guides(fill = 'none') +
      scale_y_continuous(breaks = seq(0, max(pop_data$Total), by = 50000), labels = scales::comma_format())
  })

# At-risk districts map
# Same as main page map, but only highlighting the most at-risk districts (Mafeteng, Mohaleâ€™s Hoek, Thaba-Tseka, and Quthing)
 output$risk_map <- renderLeaflet({ 
  #filtered_data <- selected_severity()
    leaflet() %>% setView(lng = 28.2336, lat = -29.6091, zoom = 7.5) %>% # set center coordinates and zoom for initial view
      addTiles() %>% # insert shape files to add district boundaries
      addGeoJSON(GeoData, weight = 1, color = "black", fill = FALSE) %>%
      addLabelOnlyMarkers(data = df_lab, ~Long, ~Lat, label = ~Name, # add district labels
      labelOptions = labelOptions(noHide = T, textsize = "9px", direction = "center", style = list(
        "color" = "black", "font-weight" = "bold", "background" = "transparent", "border" = "none", "box-shadow" = "none"))) %>%
      
      # add fill based on "Show Triggered" Input
      addPolygons(data = four_ondgeojson, color = "#444444", weight = 1, smoothFactor = 0.5,
      opacity = 1.0, fillOpacity = 0.77,
      fillColor = ~"#26828e", 
      highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE))
  })
  
  # function to reset map back to original view
  observeEvent(input$reset_riskmap_button, {
    leafletProxy("risk_map") %>% setView(lng = 28.2336, lat = -29.6091, zoom = 7.5)
    #updateSelectInput(session, "Trigger_Level", selected = 1)
  })


# Rainfall Graph
output$rain_plot <- renderPlotly({
      # Initialize plot with rain_data as the data source
    plot_ly(data = rain_data, type = 'scatter', mode = 'lines', x = ~Year, y = ~RainHistory, name = 'Rain History (mm)', color = '#fb9b06') %>%
      # Add a trace for Rain Forecast as a bar plot, assigning it to the secondary y-axis
      add_trace(type = 'bar', x = ~Month, y = ~RainForecast, name = 'Rain Forecast (% Chance of Exceeding Threshold)', yaxis = 'y2', marker = list(color = '#21918c')) %>%
      # Configure the layout settings for the plot
      layout(title = "",
             yaxis2 = list(overlaying = "y", side = "right", title = "Bar Data"), # Configure the secondary y-axis
             xaxis = list(title = "Time", tickmode = "array", tickvals = unique(rain_data$Year), ticktext = unique(rain_data$Year)),
             yaxis = list(title = "Line Data"), # Set y-axis title for the main trace (Rain History)
             bargroupgap = 0.1, # Set the gap between bar groups
             bargap = 0.1  # et the gap between bars within a group
             # NOTE: bargroupgap & bargap arguments will be ignored if a width argument is added to plot_ly
             # NOTE: these is missing data for months, so adjusting the above arguments fill not fix the gaps in the graph
      ) %>%
    config(displayModeBar = FALSE) %>% # Disable the display mode bar for the plot
    layout(margin = list(l = 50, r = 10, b = 50, t = 50), # Set plot margins
    xaxis = list(fixedrange = TRUE), # Remove zoom option for x-axis
    yaxis = list(fixedrange = TRUE), # Remove zoom option for both y-axes
    yaxis2 = list(fixedrange = TRUE))
  })
  
}


shinyApp(ui, server)
#shiny::runApp("~/Desktop/Columbia/Fall 23")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

